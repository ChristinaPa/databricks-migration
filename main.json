{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.17.1.54307",
      "templateHash": "12727508869752819882"
    }
  },
  "parameters": {
    "endpointType": {
      "type": "string",
      "defaultValue": "PvtHyb",
      "allowedValues": [
        "Pub",
        "Pvt",
        "PvtHyb"
      ]
    },
    "eventHubSku": {
      "type": "string",
      "defaultValue": "Standard",
      "allowedValues": [
        "Basic",
        "Standard"
      ]
    },
    "blobAccountName": {
      "type": "string",
      "defaultValue": "[format('adls{0}', uniqueString(resourceGroup().id))]"
    },
    "containerName": {
      "type": "string",
      "defaultValue": "data"
    },
    "eHRuleName": {
      "type": "string",
      "defaultValue": "rule",
      "metadata": {
        "description": ""
      }
    },
    "fileuploaduri": {
      "type": "string",
      "defaultValue": "https://raw.githubusercontent.com/DatabricksFactory/databricks-migration/main/allin1.ps1",
      "metadata": {
        "description": "The URI of script file to upload blob container"
      }
    },
    "identityName": {
      "type": "string",
      "defaultValue": "PostDeploymentScriptuserAssignedName",
      "metadata": {
        "description": "Name of identity"
      }
    },
    "uniqueSuffix": {
      "type": "string",
      "defaultValue": "[substring(uniqueString(resourceGroup().id), 0, 6)]",
      "metadata": {
        "description": "Unique Suffix"
      }
    },
    "firstuniquestring": {
      "type": "string",
      "defaultValue": "[format('firstunique{0}', parameters('uniqueSuffix'))]",
      "metadata": {
        "description": "firstuniquestring"
      }
    },
    "seconduniquestring": {
      "type": "string",
      "defaultValue": "[format('secondunique{0}', parameters('uniqueSuffix'))]",
      "metadata": {
        "description": "seconduniquestring"
      }
    },
    "utcValue": {
      "type": "string",
      "defaultValue": "[utcNow()]"
    },
    "ctrlDeployStorageAccount": {
      "type": "bool",
      "defaultValue": true
    },
    "ctrlDeployKeyVault": {
      "type": "bool",
      "defaultValue": true
    },
    "ctrlDeployEventHub": {
      "type": "bool",
      "defaultValue": true
    },
    "ctrlDeployNotebook": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Controls the execution of notebook deployment script"
      }
    },
    "ctrlDeployPipeline": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Controls the execution of pipeline deployment script"
      }
    },
    "ctrlDeployCluster": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Controls the execution of cluster deployment script"
      }
    },
    "lifetimeSeconds": {
      "type": "int",
      "defaultValue": 1200,
      "metadata": {
        "description": "Time to live of the Databricks token in seconds"
      }
    },
    "comment": {
      "type": "string",
      "defaultValue": "ARM deployment",
      "metadata": {
        "description": "Side note on the token generation"
      }
    },
    "clusterName": {
      "type": "string",
      "defaultValue": "dbcluster",
      "metadata": {
        "description": "Name of the Databricks cluster"
      }
    },
    "sparkVersion": {
      "type": "string",
      "defaultValue": "11.3.x-scala2.12",
      "metadata": {
        "description": "Version of Spark in the cluster"
      }
    },
    "autoTerminationMinutes": {
      "type": "int",
      "defaultValue": 30,
      "metadata": {
        "description": "Cluster terminates after specified minutes of inactivity"
      }
    },
    "numWorkers": {
      "type": "string",
      "defaultValue": "2",
      "metadata": {
        "description": "Number of worker nodes"
      }
    },
    "nodeTypeId": {
      "type": "string",
      "defaultValue": "Standard_DS3_v2",
      "metadata": {
        "description": "Type of worker node"
      }
    },
    "driverNodeTypeId": {
      "type": "string",
      "defaultValue": "Standard_DS3_v2",
      "metadata": {
        "description": "Type of driver node"
      }
    },
    "retryLimit": {
      "type": "int",
      "defaultValue": 15,
      "metadata": {
        "description": "Max number of retries"
      }
    },
    "retryTime": {
      "type": "int",
      "defaultValue": 60,
      "metadata": {
        "description": "Interval between each retries in seconds"
      }
    },
    "pipelineName": {
      "type": "string",
      "defaultValue": "Sample Pipeline",
      "metadata": {
        "description": "NAme of the pipeline"
      }
    },
    "storagePath": {
      "type": "string",
      "defaultValue": "dbfs:/user/hive/warehouse",
      "metadata": {
        "description": "Path where DLT will be created"
      }
    },
    "targetSchemaName": {
      "type": "string",
      "defaultValue": "Sample",
      "metadata": {
        "description": "Target schema name"
      }
    },
    "minWorkers": {
      "type": "int",
      "defaultValue": 1,
      "metadata": {
        "description": "Min workers"
      }
    },
    "maxWorkers": {
      "type": "int",
      "defaultValue": 5,
      "metadata": {
        "description": "Max workers"
      }
    },
    "notebookPath": {
      "type": "string",
      "defaultValue": "https://raw.githubusercontent.com/DatabricksFactory/databricks-migration/main/Artifacts",
      "metadata": {
        "description": "Path of the notebook to be uploaded"
      }
    },
    "disablePublicIp": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Specifies whether to deploy Azure Databricks workspace with secure cluster connectivity (SCC) enabled or not (No Public IP)."
      }
    },
    "nsgName": {
      "type": "string",
      "defaultValue": "databricks-nsg",
      "metadata": {
        "description": "The name of the network security group to create."
      }
    },
    "pricingTier": {
      "type": "string",
      "defaultValue": "premium",
      "allowedValues": [
        "trial",
        "standard",
        "premium"
      ],
      "metadata": {
        "description": "The pricing tier of workspace."
      }
    },
    "privateSubnetCidr": {
      "type": "string",
      "defaultValue": "10.179.0.0/18",
      "metadata": {
        "description": "CIDR range for the private subnet."
      }
    },
    "privateSubnetName": {
      "type": "string",
      "defaultValue": "private-subnet",
      "metadata": {
        "description": "The name of the private subnet to create."
      }
    },
    "publicSubnetCidr": {
      "type": "string",
      "defaultValue": "10.179.64.0/18",
      "metadata": {
        "description": "CIDR range for the public subnet."
      }
    },
    "privateEndpointSubnetCidr": {
      "type": "string",
      "defaultValue": "10.179.128.0/24",
      "metadata": {
        "description": "CIDR range for the private endpoint subnet.."
      }
    },
    "publicSubnetName": {
      "type": "string",
      "defaultValue": "public-subnet",
      "metadata": {
        "description": "The name of the public subnet to create."
      }
    },
    "requiredNsgRules": {
      "type": "string",
      "defaultValue": "NoAzureDatabricksRules",
      "allowedValues": [
        "AllRules",
        "NoAzureDatabricksRules"
      ],
      "metadata": {
        "description": "Indicates whether to retain or remove the AzureDatabricks outbound NSG rule - possible values are AllRules or NoAzureDatabricksRules."
      }
    },
    "vnetCidr": {
      "type": "string",
      "defaultValue": "10.179.0.0/16",
      "metadata": {
        "description": "CIDR range for the vnet."
      }
    },
    "vnetName": {
      "type": "string",
      "defaultValue": "databricks-vnet",
      "metadata": {
        "description": "The name of the virtual network to create."
      }
    },
    "PrivateEndpointSubnetName": {
      "type": "string",
      "defaultValue": "default",
      "metadata": {
        "description": "The name of the subnet to create the private endpoint in."
      }
    },
    "workspaceName": {
      "type": "string",
      "defaultValue": "default",
      "metadata": {
        "description": "The name of the Azure Databricks workspace to create."
      }
    }
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "Network_Deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "PrivateEndpointSubnetName": {
            "value": "[parameters('PrivateEndpointSubnetName')]"
          },
          "nsgName": {
            "value": "[parameters('nsgName')]"
          },
          "privateEndpointSubnetCidr": {
            "value": "[parameters('privateEndpointSubnetCidr')]"
          },
          "privateSubnetCidr": {
            "value": "[parameters('privateSubnetCidr')]"
          },
          "privateSubnetName": {
            "value": "[parameters('privateSubnetName')]"
          },
          "publicSubnetCidr": {
            "value": "[parameters('publicSubnetCidr')]"
          },
          "publicSubnetName": {
            "value": "[parameters('publicSubnetName')]"
          },
          "vnetCidr": {
            "value": "[parameters('vnetCidr')]"
          },
          "vnetName": {
            "value": "[parameters('vnetName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.17.1.54307",
              "templateHash": "13929841164623520400"
            }
          },
          "parameters": {
            "nsgName": {
              "type": "string",
              "metadata": {
                "description": "The name of the network security group to create."
              }
            },
            "vnetName": {
              "type": "string",
              "metadata": {
                "description": "The name of the virtual network to create."
              }
            },
            "vnetCidr": {
              "type": "string",
              "metadata": {
                "description": "CIDR range for the vnet."
              }
            },
            "publicSubnetName": {
              "type": "string",
              "metadata": {
                "description": "The name of the public subnet to create."
              }
            },
            "publicSubnetCidr": {
              "type": "string",
              "metadata": {
                "description": "CIDR range for the public subnet."
              }
            },
            "privateSubnetName": {
              "type": "string",
              "metadata": {
                "description": "The name of the private subnet to create."
              }
            },
            "privateSubnetCidr": {
              "type": "string",
              "metadata": {
                "description": "CIDR range for the private subnet."
              }
            },
            "PrivateEndpointSubnetName": {
              "type": "string",
              "metadata": {
                "description": "The name of the subnet to create the private endpoint in."
              }
            },
            "privateEndpointSubnetCidr": {
              "type": "string",
              "metadata": {
                "description": "CIDR range for the private endpoint subnet.."
              }
            }
          },
          "variables": {
            "location": "[resourceGroup().location]"
          },
          "resources": [
            {
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2021-03-01",
              "name": "[parameters('nsgName')]",
              "location": "[variables('location')]",
              "properties": {
                "securityRules": [
                  {
                    "name": "Microsoft.Databricks-workspaces_UseOnly_databricks-worker-to-worker-inbound",
                    "properties": {
                      "description": "Required for worker nodes communication within a cluster.",
                      "protocol": "*",
                      "sourcePortRange": "*",
                      "destinationPortRange": "*",
                      "sourceAddressPrefix": "VirtualNetwork",
                      "destinationAddressPrefix": "VirtualNetwork",
                      "access": "Allow",
                      "priority": 100,
                      "direction": "Inbound"
                    }
                  },
                  {
                    "name": "Microsoft.Databricks-workspaces_UseOnly_databricks-worker-to-databricks-webapp",
                    "properties": {
                      "description": "Required for workers communication with Databricks Webapp.",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "443",
                      "sourceAddressPrefix": "VirtualNetwork",
                      "destinationAddressPrefix": "AzureDatabricks",
                      "access": "Allow",
                      "priority": 100,
                      "direction": "Outbound"
                    }
                  },
                  {
                    "name": "Microsoft.Databricks-workspaces_UseOnly_databricks-worker-to-sql",
                    "properties": {
                      "description": "Required for workers communication with Azure SQL services.",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "3306",
                      "sourceAddressPrefix": "VirtualNetwork",
                      "destinationAddressPrefix": "Sql",
                      "access": "Allow",
                      "priority": 101,
                      "direction": "Outbound"
                    }
                  },
                  {
                    "name": "Microsoft.Databricks-workspaces_UseOnly_databricks-worker-to-storage",
                    "properties": {
                      "description": "Required for workers communication with Azure Storage services.",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "443",
                      "sourceAddressPrefix": "VirtualNetwork",
                      "destinationAddressPrefix": "Storage",
                      "access": "Allow",
                      "priority": 102,
                      "direction": "Outbound"
                    }
                  },
                  {
                    "name": "Microsoft.Databricks-workspaces_UseOnly_databricks-worker-to-worker-outbound",
                    "properties": {
                      "description": "Required for worker nodes communication within a cluster.",
                      "protocol": "*",
                      "sourcePortRange": "*",
                      "destinationPortRange": "*",
                      "sourceAddressPrefix": "VirtualNetwork",
                      "destinationAddressPrefix": "VirtualNetwork",
                      "access": "Allow",
                      "priority": 103,
                      "direction": "Outbound"
                    }
                  },
                  {
                    "name": "Microsoft.Databricks-workspaces_UseOnly_databricks-worker-to-eventhub",
                    "properties": {
                      "description": "Required for worker communication with Azure Eventhub services.",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "9093",
                      "sourceAddressPrefix": "VirtualNetwork",
                      "destinationAddressPrefix": "EventHub",
                      "access": "Allow",
                      "priority": 104,
                      "direction": "Outbound"
                    }
                  }
                ]
              }
            },
            {
              "type": "Microsoft.Network/virtualNetworks",
              "apiVersion": "2021-08-01",
              "name": "[parameters('vnetName')]",
              "location": "[variables('location')]",
              "properties": {
                "addressSpace": {
                  "addressPrefixes": [
                    "[parameters('vnetCidr')]"
                  ]
                },
                "subnets": [
                  {
                    "name": "[parameters('publicSubnetName')]",
                    "properties": {
                      "addressPrefix": "[parameters('publicSubnetCidr')]",
                      "networkSecurityGroup": {
                        "id": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('nsgName'))]"
                      },
                      "serviceEndpoints": [
                        {
                          "service": "Microsoft.Storage",
                          "locations": [
                            "[resourceGroup().location]"
                          ]
                        }
                      ],
                      "delegations": [
                        {
                          "name": "databricks-del-public",
                          "properties": {
                            "serviceName": "Microsoft.Databricks/workspaces"
                          }
                        }
                      ]
                    }
                  },
                  {
                    "name": "[parameters('privateSubnetName')]",
                    "properties": {
                      "addressPrefix": "[parameters('privateSubnetCidr')]",
                      "networkSecurityGroup": {
                        "id": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('nsgName'))]"
                      },
                      "delegations": [
                        {
                          "name": "databricks-del-private",
                          "properties": {
                            "serviceName": "Microsoft.Databricks/workspaces"
                          }
                        }
                      ]
                    }
                  },
                  {
                    "name": "[parameters('PrivateEndpointSubnetName')]",
                    "properties": {
                      "addressPrefix": "[parameters('privateEndpointSubnetCidr')]",
                      "privateEndpointNetworkPolicies": "Disabled"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('nsgName'))]"
              ]
            }
          ],
          "outputs": {
            "vnetResourceId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the VNet"
              },
              "value": "[resourceId('Microsoft.Network/virtualNetworks', parameters('vnetName'))]"
            }
          }
        }
      }
    },
    {
      "condition": "[equals(parameters('endpointType'), 'Pub')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "Databricks_Public_Deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "pricingTier": {
            "value": "[parameters('pricingTier')]"
          },
          "workspaceName": {
            "value": "[parameters('workspaceName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.17.1.54307",
              "templateHash": "10327251689573557822"
            }
          },
          "parameters": {
            "workspaceName": {
              "type": "string",
              "metadata": {
                "description": "The name of the Azure Databricks workspace to create."
              }
            },
            "pricingTier": {
              "type": "string"
            }
          },
          "variables": {
            "location": "[resourceGroup().location]",
            "managedResourceGroupName": "[format('databricks-rg-{0}-{1}', parameters('workspaceName'), uniqueString(parameters('workspaceName'), resourceGroup().id))]",
            "trimmedMRGName": "[substring(variables('managedResourceGroupName'), 0, min(length(variables('managedResourceGroupName')), 90))]",
            "managedResourceGroupId": "[format('{0}/resourceGroups/{1}', subscription().id, variables('trimmedMRGName'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Databricks/workspaces",
              "apiVersion": "2018-04-01",
              "name": "[parameters('workspaceName')]",
              "location": "[variables('location')]",
              "sku": {
                "name": "[parameters('pricingTier')]"
              },
              "properties": {
                "managedResourceGroupId": "[variables('managedResourceGroupId')]"
              }
            }
          ]
        }
      }
    },
    {
      "condition": "[equals(parameters('endpointType'), 'Pvt')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "Databricks_Private_Deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "customVirtualNetworkResourceId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'Network_Deployment'), '2022-09-01').outputs.vnetResourceId.value]"
          },
          "disablePublicIp": {
            "value": "[parameters('disablePublicIp')]"
          },
          "pricingTier": {
            "value": "[parameters('pricingTier')]"
          },
          "privateSubnetName": {
            "value": "[parameters('privateSubnetName')]"
          },
          "publicSubnetName": {
            "value": "[parameters('publicSubnetName')]"
          },
          "requiredNsgRules": {
            "value": "[parameters('requiredNsgRules')]"
          },
          "workspaceName": {
            "value": "[parameters('workspaceName')]"
          },
          "PrivateEndpointSubnetName": {
            "value": "[parameters('PrivateEndpointSubnetName')]"
          },
          "vnetName": {
            "value": "[parameters('vnetName')]"
          },
          "vnetResourceId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'Network_Deployment'), '2022-09-01').outputs.vnetResourceId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.17.1.54307",
              "templateHash": "9393018165807964162"
            }
          },
          "parameters": {
            "workspaceName": {
              "type": "string",
              "metadata": {
                "description": "The name of the Azure Databricks workspace to create."
              }
            },
            "pricingTier": {
              "type": "string"
            },
            "publicSubnetName": {
              "type": "string",
              "metadata": {
                "description": "The name of the public subnet to create."
              }
            },
            "privateSubnetName": {
              "type": "string",
              "metadata": {
                "description": "The name of the private subnet to create."
              }
            },
            "disablePublicIp": {
              "type": "bool",
              "metadata": {
                "description": "Specifies whether to deploy Azure Databricks workspace with secure cluster connectivity (SCC) enabled or not (No Public IP)."
              }
            },
            "requiredNsgRules": {
              "type": "string"
            },
            "customVirtualNetworkResourceId": {
              "type": "string"
            },
            "vnetName": {
              "type": "string",
              "metadata": {
                "description": "The name of the virtual network to create."
              }
            },
            "PrivateEndpointSubnetName": {
              "type": "string",
              "metadata": {
                "description": "The name of the subnet to create the private endpoint in."
              }
            },
            "vnetResourceId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of VNet"
              }
            }
          },
          "variables": {
            "location": "[resourceGroup().location]",
            "managedResourceGroupName": "[format('databricks-rg-{0}-{1}', parameters('workspaceName'), uniqueString(parameters('workspaceName'), resourceGroup().id))]",
            "trimmedMRGName": "[substring(variables('managedResourceGroupName'), 0, min(length(variables('managedResourceGroupName')), 90))]",
            "managedResourceGroupId": "[format('{0}/resourceGroups/{1}', subscription().id, variables('trimmedMRGName'))]",
            "privateEndpointName": "[format('{0}-pvtEndpoint', parameters('workspaceName'))]",
            "privateDnsZoneName": "privatelink.azuredatabricks.net",
            "pvtEndpointDnsGroupName": "[format('{0}/mydnsgroupname', variables('privateEndpointName'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Databricks/workspaces",
              "apiVersion": "2018-04-01",
              "name": "[parameters('workspaceName')]",
              "location": "[variables('location')]",
              "sku": {
                "name": "[parameters('pricingTier')]"
              },
              "properties": {
                "managedResourceGroupId": "[variables('managedResourceGroupId')]",
                "parameters": {
                  "customVirtualNetworkId": {
                    "value": "[parameters('customVirtualNetworkResourceId')]"
                  },
                  "customPublicSubnetName": {
                    "value": "[parameters('publicSubnetName')]"
                  },
                  "customPrivateSubnetName": {
                    "value": "[parameters('privateSubnetName')]"
                  },
                  "enableNoPublicIp": {
                    "value": "[parameters('disablePublicIp')]"
                  }
                },
                "publicNetworkAccess": "Disabled",
                "requiredNsgRules": "[parameters('requiredNsgRules')]"
              }
            },
            {
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2021-08-01",
              "name": "[variables('privateEndpointName')]",
              "location": "[variables('location')]",
              "properties": {
                "subnet": {
                  "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('PrivateEndpointSubnetName'))]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "[variables('privateEndpointName')]",
                    "properties": {
                      "privateLinkServiceId": "[resourceId('Microsoft.Databricks/workspaces', parameters('workspaceName'))]",
                      "groupIds": [
                        "databricks_ui_api"
                      ]
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Databricks/workspaces', parameters('workspaceName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
              "apiVersion": "2020-06-01",
              "name": "[format('{0}/{1}', variables('privateDnsZoneName'), format('{0}-link', variables('privateDnsZoneName')))]",
              "location": "global",
              "properties": {
                "registrationEnabled": false,
                "virtualNetwork": {
                  "id": "[parameters('vnetResourceId')]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', variables('privateDnsZoneName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateDnsZones",
              "apiVersion": "2020-06-01",
              "name": "[variables('privateDnsZoneName')]",
              "location": "global",
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', variables('privateEndpointName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2021-12-01",
              "name": "[variables('pvtEndpointDnsGroupName')]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "config1",
                    "properties": {
                      "privateDnsZoneId": "[resourceId('Microsoft.Network/privateDnsZones', variables('privateDnsZoneName'))]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', variables('privateDnsZoneName'))]",
                "[resourceId('Microsoft.Network/privateEndpoints', variables('privateEndpointName'))]"
              ]
            }
          ],
          "outputs": {
            "databricksPvtResourceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Databricks/workspaces', parameters('workspaceName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'Network_Deployment')]"
      ]
    },
    {
      "condition": "[equals(parameters('endpointType'), 'PvtHyb')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "Databricks_Private_Hybrid_Deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "customVirtualNetworkResourceId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'Network_Deployment'), '2022-09-01').outputs.vnetResourceId.value]"
          },
          "disablePublicIp": {
            "value": "[parameters('disablePublicIp')]"
          },
          "pricingTier": {
            "value": "[parameters('pricingTier')]"
          },
          "privateSubnetName": {
            "value": "[parameters('privateSubnetName')]"
          },
          "publicSubnetName": {
            "value": "[parameters('publicSubnetName')]"
          },
          "requiredNsgRules": {
            "value": "[parameters('requiredNsgRules')]"
          },
          "workspaceName": {
            "value": "[parameters('workspaceName')]"
          },
          "PrivateEndpointSubnetName": {
            "value": "[parameters('PrivateEndpointSubnetName')]"
          },
          "vnetName": {
            "value": "[parameters('vnetName')]"
          },
          "vnetResourceId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'Network_Deployment'), '2022-09-01').outputs.vnetResourceId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.17.1.54307",
              "templateHash": "6258363348076417135"
            }
          },
          "parameters": {
            "workspaceName": {
              "type": "string",
              "metadata": {
                "description": "The name of the Azure Databricks workspace to create."
              }
            },
            "pricingTier": {
              "type": "string"
            },
            "publicSubnetName": {
              "type": "string",
              "metadata": {
                "description": "The name of the public subnet to create."
              }
            },
            "privateSubnetName": {
              "type": "string",
              "metadata": {
                "description": "The name of the private subnet to create."
              }
            },
            "disablePublicIp": {
              "type": "bool",
              "metadata": {
                "description": "Specifies whether to deploy Azure Databricks workspace with secure cluster connectivity (SCC) enabled or not (No Public IP)."
              }
            },
            "requiredNsgRules": {
              "type": "string"
            },
            "customVirtualNetworkResourceId": {
              "type": "string"
            },
            "vnetName": {
              "type": "string",
              "metadata": {
                "description": "The name of the virtual network to create."
              }
            },
            "PrivateEndpointSubnetName": {
              "type": "string",
              "metadata": {
                "description": "The name of the subnet to create the private endpoint in."
              }
            },
            "vnetResourceId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of VNet"
              }
            }
          },
          "variables": {
            "location": "[resourceGroup().location]",
            "managedResourceGroupName": "[format('databricks-rg-{0}-{1}', parameters('workspaceName'), uniqueString(parameters('workspaceName'), resourceGroup().id))]",
            "trimmedMRGName": "[substring(variables('managedResourceGroupName'), 0, min(length(variables('managedResourceGroupName')), 90))]",
            "managedResourceGroupId": "[format('{0}/resourceGroups/{1}', subscription().id, variables('trimmedMRGName'))]",
            "privateEndpointName": "[format('{0}-pvtEndpoint', parameters('workspaceName'))]",
            "privateDnsZoneName": "privatelink.azuredatabricks.net",
            "pvtEndpointDnsGroupName": "[format('{0}/mydnsgroupname', variables('privateEndpointName'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Databricks/workspaces",
              "apiVersion": "2018-04-01",
              "name": "[parameters('workspaceName')]",
              "location": "[variables('location')]",
              "sku": {
                "name": "[parameters('pricingTier')]"
              },
              "properties": {
                "managedResourceGroupId": "[variables('managedResourceGroupId')]",
                "parameters": {
                  "customVirtualNetworkId": {
                    "value": "[parameters('customVirtualNetworkResourceId')]"
                  },
                  "customPublicSubnetName": {
                    "value": "[parameters('publicSubnetName')]"
                  },
                  "customPrivateSubnetName": {
                    "value": "[parameters('privateSubnetName')]"
                  },
                  "enableNoPublicIp": {
                    "value": "[parameters('disablePublicIp')]"
                  }
                },
                "publicNetworkAccess": "Enabled",
                "requiredNsgRules": "[parameters('requiredNsgRules')]"
              }
            },
            {
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2021-08-01",
              "name": "[variables('privateEndpointName')]",
              "location": "[variables('location')]",
              "properties": {
                "subnet": {
                  "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('PrivateEndpointSubnetName'))]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "[variables('privateEndpointName')]",
                    "properties": {
                      "privateLinkServiceId": "[resourceId('Microsoft.Databricks/workspaces', parameters('workspaceName'))]",
                      "groupIds": [
                        "databricks_ui_api"
                      ]
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Databricks/workspaces', parameters('workspaceName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
              "apiVersion": "2020-06-01",
              "name": "[format('{0}/{1}', variables('privateDnsZoneName'), format('{0}-link', variables('privateDnsZoneName')))]",
              "location": "global",
              "properties": {
                "registrationEnabled": false,
                "virtualNetwork": {
                  "id": "[parameters('vnetResourceId')]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', variables('privateDnsZoneName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateDnsZones",
              "apiVersion": "2020-06-01",
              "name": "[variables('privateDnsZoneName')]",
              "location": "global",
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', variables('privateEndpointName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2021-12-01",
              "name": "[variables('pvtEndpointDnsGroupName')]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "config1",
                    "properties": {
                      "privateDnsZoneId": "[resourceId('Microsoft.Network/privateDnsZones', variables('privateDnsZoneName'))]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', variables('privateDnsZoneName'))]",
                "[resourceId('Microsoft.Network/privateEndpoints', variables('privateEndpointName'))]"
              ]
            }
          ],
          "outputs": {
            "databricksPvtHybResourceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Databricks/workspaces', parameters('workspaceName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'Network_Deployment')]"
      ]
    },
    {
      "condition": "[parameters('ctrlDeployStorageAccount')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "Storage_Account_Deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "blobAccountName": {
            "value": "[parameters('blobAccountName')]"
          },
          "containerName": {
            "value": "[parameters('containerName')]"
          },
          "publicSubnetName": {
            "value": "[parameters('publicSubnetName')]"
          },
          "vnetName": {
            "value": "[parameters('vnetName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.17.1.54307",
              "templateHash": "11447945426226011589"
            }
          },
          "parameters": {
            "blobAccountName": {
              "type": "string"
            },
            "vnetName": {
              "type": "string",
              "metadata": {
                "description": "The name of the virtual network to create."
              }
            },
            "publicSubnetName": {
              "type": "string",
              "metadata": {
                "description": "The name of the public subnet to create."
              }
            },
            "containerName": {
              "type": "string"
            }
          },
          "variables": {
            "location": "[resourceGroup().location]"
          },
          "resources": [
            {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2021-04-01",
              "name": "[parameters('blobAccountName')]",
              "location": "[variables('location')]",
              "kind": "StorageV2",
              "sku": {
                "name": "Standard_LRS"
              },
              "properties": {
                "isHnsEnabled": true,
                "networkAcls": {
                  "bypass": "AzureServices",
                  "virtualNetworkRules": [
                    {
                      "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('publicSubnetName'))]",
                      "action": "Allow",
                      "state": "succeeded"
                    }
                  ],
                  "ipRules": [],
                  "defaultAction": "Allow"
                },
                "minimumTlsVersion": "TLS1_2",
                "allowBlobPublicAccess": false,
                "supportsHttpsTrafficOnly": true,
                "accessTier": "Hot"
              }
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
              "apiVersion": "2021-06-01",
              "name": "[format('{0}/default/{1}', parameters('blobAccountName'), parameters('containerName'))]",
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('blobAccountName'))]"
              ]
            }
          ],
          "outputs": {
            "blobAccountResourceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Storage/storageAccounts', parameters('blobAccountName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'Network_Deployment')]"
      ]
    },
    {
      "condition": "[parameters('ctrlDeployEventHub')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "EventHub_Deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "eHRuleName": {
            "value": "[parameters('eHRuleName')]"
          },
          "eventHubSku": {
            "value": "[parameters('eventHubSku')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.17.1.54307",
              "templateHash": "2471592076770621283"
            }
          },
          "parameters": {
            "eventHubSku": {
              "type": "string",
              "allowedValues": [
                "Basic",
                "Standard"
              ]
            },
            "eHRuleName": {
              "type": "string",
              "metadata": {
                "description": ""
              }
            }
          },
          "variables": {
            "randomString": "[substring(guid(resourceGroup().id), 0, 6)]",
            "eventHubNamespaceName": "[format('streamdata-{0}-ns', variables('randomString'))]",
            "location": "[resourceGroup().location]",
            "eventHubName": "[format('streamdata-{0}-ns', variables('randomString'))]"
          },
          "resources": [
            {
              "type": "Microsoft.EventHub/namespaces",
              "apiVersion": "2021-11-01",
              "name": "[variables('eventHubNamespaceName')]",
              "location": "[variables('location')]",
              "sku": {
                "name": "[parameters('eventHubSku')]",
                "tier": "[parameters('eventHubSku')]",
                "capacity": 1
              },
              "properties": {
                "isAutoInflateEnabled": false,
                "maximumThroughputUnits": 0
              }
            },
            {
              "type": "Microsoft.EventHub/namespaces/eventhubs",
              "apiVersion": "2021-01-01-preview",
              "name": "[format('{0}/{1}', variables('eventHubNamespaceName'), variables('eventHubName'))]",
              "properties": {
                "messageRetentionInDays": 7,
                "partitionCount": 1
              },
              "dependsOn": [
                "[resourceId('Microsoft.EventHub/namespaces', variables('eventHubNamespaceName'))]"
              ]
            },
            {
              "type": "Microsoft.EventHub/namespaces/eventhubs/authorizationRules",
              "apiVersion": "2021-01-01-preview",
              "name": "[format('{0}/{1}/{2}', variables('eventHubNamespaceName'), variables('eventHubName'), parameters('eHRuleName'))]",
              "properties": {
                "rights": [
                  "Send",
                  "Listen"
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.EventHub/namespaces/eventhubs', variables('eventHubNamespaceName'), variables('eventHubName'))]"
              ]
            }
          ],
          "outputs": {
            "eventhubResourceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.EventHub/namespaces', variables('eventHubNamespaceName'))]"
            }
          }
        }
      }
    },
    {
      "condition": "[parameters('ctrlDeployKeyVault')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "Key_Vault_Deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "utcValue": {
            "value": "[parameters('utcValue')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.17.1.54307",
              "templateHash": "7310148213244612204"
            }
          },
          "parameters": {
            "utcValue": {
              "type": "string"
            }
          },
          "variables": {
            "location": "[resourceGroup().location]"
          },
          "resources": [
            {
              "type": "Microsoft.KeyVault/vaults",
              "apiVersion": "2021-04-01-preview",
              "name": "[format('vault{0}', parameters('utcValue'))]",
              "location": "[variables('location')]",
              "properties": {
                "sku": {
                  "family": "A",
                  "name": "standard"
                },
                "softDeleteRetentionInDays": 7,
                "networkAcls": {
                  "defaultAction": "Deny",
                  "bypass": "AzureServices",
                  "ipRules": [],
                  "virtualNetworkRules": []
                },
                "tenantId": "[subscription().tenantId]",
                "accessPolicies": []
              }
            }
          ],
          "outputs": {
            "keyvaultResourceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.KeyVault/vaults', format('vault{0}', parameters('utcValue')))]"
            }
          }
        }
      }
    },
    {
      "condition": "[or(equals(parameters('endpointType'), 'Pvt'), equals(parameters('endpointType'), 'PvtHyb'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "Storage_Private_Endpoint_Deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "PrivateEndpointSubnetName": {
            "value": "[parameters('PrivateEndpointSubnetName')]"
          },
          "blobAccountResourceId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'Storage_Account_Deployment'), '2022-09-01').outputs.blobAccountResourceId.value]"
          },
          "vnetName": {
            "value": "[parameters('vnetName')]"
          },
          "vnetResourceId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'Network_Deployment'), '2022-09-01').outputs.vnetResourceId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.17.1.54307",
              "templateHash": "1694743361720408758"
            }
          },
          "parameters": {
            "vnetName": {
              "type": "string",
              "metadata": {
                "description": "The name of the virtual network to create."
              }
            },
            "PrivateEndpointSubnetName": {
              "type": "string",
              "metadata": {
                "description": "The name of the subnet to create the private endpoint in."
              }
            },
            "blobAccountResourceId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of blob account"
              }
            },
            "vnetResourceId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of vnet"
              }
            }
          },
          "variables": {
            "privateEndpointNamestorage": "storage-pvtEndpoint",
            "privateDnsZoneNamestorage": "[format('privatelink.dfs.{0}', environment().suffixes.storage)]",
            "pvtEndpointDnsGroupNamestorage": "storage-pvtEndpoint/mydnsgroupname",
            "targetSubResourceDfs": "dfs",
            "location": "[resourceGroup().location]"
          },
          "resources": [
            {
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2021-08-01",
              "name": "[variables('privateEndpointNamestorage')]",
              "location": "[variables('location')]",
              "properties": {
                "subnet": {
                  "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('PrivateEndpointSubnetName'))]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "[variables('privateEndpointNamestorage')]",
                    "properties": {
                      "privateLinkServiceId": "[parameters('blobAccountResourceId')]",
                      "groupIds": [
                        "[variables('targetSubResourceDfs')]"
                      ]
                    }
                  }
                ]
              }
            },
            {
              "type": "Microsoft.Network/privateDnsZones",
              "apiVersion": "2020-06-01",
              "name": "[variables('privateDnsZoneNamestorage')]",
              "location": "global",
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', variables('privateEndpointNamestorage'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
              "apiVersion": "2020-06-01",
              "name": "[format('{0}/{1}', variables('privateDnsZoneNamestorage'), format('{0}-link', variables('privateDnsZoneNamestorage')))]",
              "location": "global",
              "properties": {
                "registrationEnabled": false,
                "virtualNetwork": {
                  "id": "[parameters('vnetResourceId')]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', variables('privateDnsZoneNamestorage'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2021-12-01",
              "name": "[variables('pvtEndpointDnsGroupNamestorage')]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "config1storage",
                    "properties": {
                      "privateDnsZoneId": "[resourceId('Microsoft.Network/privateDnsZones', variables('privateDnsZoneNamestorage'))]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', variables('privateDnsZoneNamestorage'))]",
                "[resourceId('Microsoft.Network/privateEndpoints', variables('privateEndpointNamestorage'))]"
              ]
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'Network_Deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'Storage_Account_Deployment')]"
      ]
    },
    {
      "condition": "[or(equals(parameters('endpointType'), 'Pvt'), equals(parameters('endpointType'), 'PvtHyb'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "EventHub_Private_Endpoint_Deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "PrivateEndpointSubnetName": {
            "value": "[parameters('PrivateEndpointSubnetName')]"
          },
          "eventhubResourceId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'EventHub_Deployment'), '2022-09-01').outputs.eventhubResourceId.value]"
          },
          "vnetName": {
            "value": "[parameters('vnetName')]"
          },
          "vnetResourceId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'Network_Deployment'), '2022-09-01').outputs.vnetResourceId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.17.1.54307",
              "templateHash": "14652359723667756474"
            }
          },
          "parameters": {
            "vnetName": {
              "type": "string",
              "metadata": {
                "description": "The name of the virtual network to create."
              }
            },
            "PrivateEndpointSubnetName": {
              "type": "string",
              "metadata": {
                "description": "The name of the subnet to create the private endpoint in."
              }
            },
            "vnetResourceId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of vnet"
              }
            },
            "eventhubResourceId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of EventHub"
              }
            }
          },
          "variables": {
            "privateEndpointNameeventhub": "eventhub-pvtEndpoint",
            "privateDnsZoneNameeventhub": "privatelink.servicebus.windows.net",
            "pvtEndpointDnsGroupNameeventhub": "eventhub-pvtEndpoint/mydnsgroupname",
            "targetSubResourceEventHub": "namespace",
            "location": "[resourceGroup().location]"
          },
          "resources": [
            {
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2021-08-01",
              "name": "[variables('privateEndpointNameeventhub')]",
              "location": "[variables('location')]",
              "properties": {
                "subnet": {
                  "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('PrivateEndpointSubnetName'))]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "[variables('privateEndpointNameeventhub')]",
                    "properties": {
                      "privateLinkServiceId": "[parameters('eventhubResourceId')]",
                      "groupIds": [
                        "[variables('targetSubResourceEventHub')]"
                      ]
                    }
                  }
                ]
              }
            },
            {
              "type": "Microsoft.Network/privateDnsZones",
              "apiVersion": "2020-06-01",
              "name": "[variables('privateDnsZoneNameeventhub')]",
              "location": "global",
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', variables('privateEndpointNameeventhub'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
              "apiVersion": "2020-06-01",
              "name": "[format('{0}/{1}', variables('privateDnsZoneNameeventhub'), format('{0}-link', variables('privateDnsZoneNameeventhub')))]",
              "location": "global",
              "properties": {
                "registrationEnabled": false,
                "virtualNetwork": {
                  "id": "[parameters('vnetResourceId')]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', variables('privateDnsZoneNameeventhub'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2021-12-01",
              "name": "[variables('pvtEndpointDnsGroupNameeventhub')]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "config1eventhub",
                    "properties": {
                      "privateDnsZoneId": "[resourceId('Microsoft.Network/privateDnsZones', variables('privateDnsZoneNameeventhub'))]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', variables('privateDnsZoneNameeventhub'))]",
                "[resourceId('Microsoft.Network/privateEndpoints', variables('privateEndpointNameeventhub'))]"
              ]
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'EventHub_Deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'Network_Deployment')]"
      ]
    },
    {
      "condition": "[or(equals(parameters('endpointType'), 'Pvt'), equals(parameters('endpointType'), 'PvtHyb'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "Key_Vault_Private_Endpoint_Deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "PrivateEndpointSubnetName": {
            "value": "[parameters('PrivateEndpointSubnetName')]"
          },
          "keyvaultResourceId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'Key_Vault_Deployment'), '2022-09-01').outputs.keyvaultResourceId.value]"
          },
          "vnetName": {
            "value": "[parameters('vnetName')]"
          },
          "vnetResourceId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'Network_Deployment'), '2022-09-01').outputs.vnetResourceId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.17.1.54307",
              "templateHash": "1719892985680008149"
            }
          },
          "parameters": {
            "vnetName": {
              "type": "string",
              "metadata": {
                "description": "The name of the virtual network to create."
              }
            },
            "PrivateEndpointSubnetName": {
              "type": "string",
              "metadata": {
                "description": "The name of the subnet to create the private endpoint in."
              }
            },
            "vnetResourceId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of vnet"
              }
            },
            "keyvaultResourceId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of EventHub"
              }
            }
          },
          "variables": {
            "privateEndpointNamevault": "keyvault-pvtEndpoint",
            "privateDnsZoneNamevault": "privatelink.vaultcore.azure.net",
            "pvtEndpointDnsGroupNamevault": "keyvault-pvtEndpoint/mydnsgroupname",
            "targetSubResourceVault": "vault",
            "location": "[resourceGroup().location]"
          },
          "resources": [
            {
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2021-08-01",
              "name": "[variables('privateEndpointNamevault')]",
              "location": "[variables('location')]",
              "properties": {
                "subnet": {
                  "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('PrivateEndpointSubnetName'))]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "[variables('privateEndpointNamevault')]",
                    "properties": {
                      "privateLinkServiceId": "[parameters('keyvaultResourceId')]",
                      "groupIds": [
                        "[variables('targetSubResourceVault')]"
                      ]
                    }
                  }
                ]
              }
            },
            {
              "type": "Microsoft.Network/privateDnsZones",
              "apiVersion": "2020-06-01",
              "name": "[variables('privateDnsZoneNamevault')]",
              "location": "global",
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', variables('privateEndpointNamevault'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
              "apiVersion": "2020-06-01",
              "name": "[format('{0}/{1}', variables('privateDnsZoneNamevault'), format('{0}-link', variables('privateDnsZoneNamevault')))]",
              "location": "global",
              "properties": {
                "registrationEnabled": false,
                "virtualNetwork": {
                  "id": "[parameters('vnetResourceId')]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', variables('privateDnsZoneNamevault'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2021-12-01",
              "name": "[variables('pvtEndpointDnsGroupNamevault')]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "config1vault",
                    "properties": {
                      "privateDnsZoneId": "[resourceId('Microsoft.Network/privateDnsZones', variables('privateDnsZoneNamevault'))]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', variables('privateDnsZoneNamevault'))]",
                "[resourceId('Microsoft.Network/privateEndpoints', variables('privateEndpointNamevault'))]"
              ]
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'Key_Vault_Deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'Network_Deployment')]"
      ]
    },
    {
      "condition": "[or(equals(parameters('endpointType'), 'Pub'), equals(parameters('endpointType'), 'PvtHyb'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "Post-Deployment_Scripts",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "autoTerminationMinutes": {
            "value": "[parameters('autoTerminationMinutes')]"
          },
          "clusterName": {
            "value": "[parameters('clusterName')]"
          },
          "comment": {
            "value": "[parameters('comment')]"
          },
          "ctrlDeployCluster": {
            "value": "[parameters('ctrlDeployCluster')]"
          },
          "ctrlDeployNotebook": {
            "value": "[parameters('ctrlDeployNotebook')]"
          },
          "ctrlDeployPipeline": {
            "value": "[parameters('ctrlDeployPipeline')]"
          },
          "driverNodeTypeId": {
            "value": "[parameters('driverNodeTypeId')]"
          },
          "fileuploaduri": {
            "value": "[parameters('fileuploaduri')]"
          },
          "firstuniquestring": {
            "value": "[parameters('firstuniquestring')]"
          },
          "identityName": {
            "value": "[parameters('identityName')]"
          },
          "lifetimeSeconds": {
            "value": "[parameters('lifetimeSeconds')]"
          },
          "nodeTypeId": {
            "value": "[parameters('nodeTypeId')]"
          },
          "numWorkers": {
            "value": "[parameters('numWorkers')]"
          },
          "retryLimit": {
            "value": "[parameters('retryLimit')]"
          },
          "retryTime": {
            "value": "[parameters('retryTime')]"
          },
          "seconduniquestring": {
            "value": "[parameters('seconduniquestring')]"
          },
          "sparkVersion": {
            "value": "[parameters('sparkVersion')]"
          },
          "workspaceName": {
            "value": "[parameters('workspaceName')]"
          },
          "pipelineName": {
            "value": "[parameters('pipelineName')]"
          },
          "notebookPath": {
            "value": "[parameters('notebookPath')]"
          },
          "storagePath": {
            "value": "[parameters('storagePath')]"
          },
          "targetSchemaName": {
            "value": "[parameters('targetSchemaName')]"
          },
          "minWorkers": {
            "value": "[parameters('minWorkers')]"
          },
          "maxWorkers": {
            "value": "[parameters('maxWorkers')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.17.1.54307",
              "templateHash": "2715414341928809178"
            }
          },
          "parameters": {
            "workspaceName": {
              "type": "string",
              "metadata": {
                "description": "The name of the Azure Databricks workspace to create."
              }
            },
            "ctrlDeployCluster": {
              "type": "bool",
              "metadata": {
                "description": "Controls the execution of cluster deployment script"
              }
            },
            "ctrlDeployNotebook": {
              "type": "bool",
              "metadata": {
                "description": "Controls the execution of notebook deployment script"
              }
            },
            "ctrlDeployPipeline": {
              "type": "bool",
              "metadata": {
                "description": "Controls the execution of pipeline deployment script"
              }
            },
            "lifetimeSeconds": {
              "type": "int",
              "metadata": {
                "description": "Time to live of the Databricks token in seconds"
              }
            },
            "comment": {
              "type": "string",
              "metadata": {
                "description": "Side note on the token generation"
              }
            },
            "clusterName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Databricks cluster"
              }
            },
            "sparkVersion": {
              "type": "string",
              "metadata": {
                "description": "Version of Spark in the cluster"
              }
            },
            "autoTerminationMinutes": {
              "type": "int",
              "metadata": {
                "description": "Cluster terminates after specified minutes of inactivity"
              }
            },
            "numWorkers": {
              "type": "string",
              "metadata": {
                "description": "Number of worker nodes"
              }
            },
            "nodeTypeId": {
              "type": "string",
              "metadata": {
                "description": "Type of worker node"
              }
            },
            "driverNodeTypeId": {
              "type": "string",
              "metadata": {
                "description": "Type of driver node"
              }
            },
            "retryLimit": {
              "type": "int",
              "metadata": {
                "description": "Max number of retries"
              }
            },
            "retryTime": {
              "type": "int",
              "metadata": {
                "description": "Interval between each retries in seconds"
              }
            },
            "pipelineName": {
              "type": "string",
              "metadata": {
                "description": "NAme of the pipeline"
              }
            },
            "storagePath": {
              "type": "string",
              "metadata": {
                "description": "Path where DLT will be created"
              }
            },
            "targetSchemaName": {
              "type": "string",
              "metadata": {
                "description": "Target schema name"
              }
            },
            "minWorkers": {
              "type": "int",
              "metadata": {
                "description": "Min workers"
              }
            },
            "maxWorkers": {
              "type": "int",
              "metadata": {
                "description": "Max workers"
              }
            },
            "notebookPath": {
              "type": "string",
              "metadata": {
                "description": "Path of the notebook to be uploaded"
              }
            },
            "fileuploaduri": {
              "type": "string",
              "metadata": {
                "description": "The URI of script file to upload blob container"
              }
            },
            "identityName": {
              "type": "string",
              "metadata": {
                "description": "Name of identity"
              }
            },
            "firstuniquestring": {
              "type": "string",
              "metadata": {
                "description": "firstuniquestring"
              }
            },
            "seconduniquestring": {
              "type": "string",
              "metadata": {
                "description": "seconduniquestring"
              }
            }
          },
          "variables": {
            "location": "[resourceGroup().location]",
            "fileuploadurivariable": "[parameters('fileuploaduri')]",
            "scriptParametersToUploadFile": "[format('-RG_NAME {0} -REGION {1} -WORKSPACE_NAME {2} -LIFETIME_SECONDS {3} -COMMENT {4} -CLUSTER_NAME {5} -SPARK_VERSION {6} -AUTOTERMINATION_MINUTES {7} -NUM_WORKERS {8} -NODE_TYPE_ID {9} -DRIVER_NODE_TYPE_ID {10} -RETRY_LIMIT {11} -RETRY_TIME {12} -CTRL_DEPLOY_CLUSTER {13} -MINWORKERS {14} -MAXWORKERS {15} -PIPELINENAME {16} -STORAGE {17} -TARGETSCHEMA {18} -CTRL_DEPLOY_NOTEBOOK {19} -CTRL_DEPLOY_PIPELINE {20} -NOTEBOOK_PATH {21}', resourceGroup().name, variables('location'), parameters('workspaceName'), parameters('lifetimeSeconds'), parameters('comment'), parameters('clusterName'), parameters('sparkVersion'), parameters('autoTerminationMinutes'), parameters('numWorkers'), parameters('nodeTypeId'), parameters('driverNodeTypeId'), parameters('retryLimit'), parameters('retryTime'), if(parameters('ctrlDeployCluster'), '$true', '$false'), parameters('minWorkers'), parameters('maxWorkers'), parameters('pipelineName'), parameters('storagePath'), parameters('targetSchemaName'), if(parameters('ctrlDeployNotebook'), '$true', '$false'), if(parameters('ctrlDeployPipeline'), '$true', '$false'), parameters('notebookPath'))]",
            "bootstrapRoleAssignmentId_var": "[guid(parameters('firstuniquestring'), parameters('seconduniquestring'))]",
            "contributorRoleDefinitionId": "B24988ac-6180-42a0-ab88-20f7382dd24c"
          },
          "resources": [
            {
              "type": "Microsoft.Resources/deploymentScripts",
              "apiVersion": "2020-10-01",
              "name": "PostDeploymentScriptForFileUpload",
              "location": "[variables('location')]",
              "kind": "AzurePowerShell",
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('identityName')))]": {}
                }
              },
              "properties": {
                "azPowerShellVersion": "7.2.4",
                "cleanupPreference": "OnSuccess",
                "retentionInterval": "P1D",
                "timeout": "PT30M",
                "arguments": "[variables('scriptParametersToUploadFile')]",
                "primaryScriptUri": "[variables('fileuploadurivariable')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('identityName'))]"
              ]
            },
            {
              "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
              "apiVersion": "2018-11-30",
              "name": "[parameters('identityName')]",
              "location": "[variables('location')]"
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2018-09-01-preview",
              "name": "[variables('bootstrapRoleAssignmentId_var')]",
              "properties": {
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', variables('contributorRoleDefinitionId'))]",
                "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('identityName')), '2018-11-30').principalId]",
                "scope": "[resourceGroup().id]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('identityName'))]"
              ]
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'Databricks_Private_Hybrid_Deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'Databricks_Public_Deployment')]"
      ]
    }
  ]
}